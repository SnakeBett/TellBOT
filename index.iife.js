var downloader=function(c){"use strict";class m{constructor(){this.downloadEventName="tvd_media_download",this.progressEventName="tvd_media_download_progress",document.addEventListener(this.downloadEventName,t=>{t.detail.urls.forEach(n=>{this.downloadTelegramMediaFile(n)})})}downloadTelegramMediaFile(t){const s=[];let n=0,a=null,r="mp4",d="";if(t.includes("stream/")){const o=this.getMediaInfoFromLink(t);o&&(d=o.fileName?o.fileName:`${o.location.id}.${r}`)}else d=t.startsWith("blob")?`${t.split("/").pop()}.${r}`:`${Math.random().toString(36).substring(2,10)}.${r}`;const g=()=>{const o=new Blob(s,{type:"video/mp4"}),i=window.URL.createObjectURL(o),e=document.createElement("a");document.body.appendChild(e),e.href=i,e.download=d,e.click(),document.body.removeChild(e),window.URL.revokeObjectURL(i)},h=(o=0,i=3)=>{fetch(t,{method:"GET",headers:{Range:`bytes=${n}-`,"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/117.0"}}).then(e=>{var u,f;if(![200,206].includes(e.status))throw new Error(`Non 200/206 response received: ${e.status}`);r=(((u=e.headers.get("Content-Type"))==null?void 0:u.split(";")[0])||"").split("/")[1],d=d.substring(0,d.indexOf(".")+1)+r;const l=(f=e.headers.get("Content-Range"))==null?void 0:f.match(/^bytes (\d+)-(\d+)\/(\d+)$/);if(!l)throw new Error("Invalid Content-Range header");const b=parseInt(l[1]),v=parseInt(l[2]),w=parseInt(l[3]);if(b!==n)throw new Error("Gap detected between responses.");if(a&&w!==a)throw new Error("Total size differs");n=v+1,a=w;const E=Math.round(n/a*100);return this.updateDownloadProgress(t,E),e.blob()}).then(e=>{if(s.push(e),!a)throw new Error("Total size is NULL");n<a?h():(g(),this.updateDownloadProgress(t,100))}).catch(e=>{e.message.includes("408")&&o<i&&setTimeout(()=>h(o+1,i),2e3)})};h()}getMediaInfoFromLink(t){const s=t.substring(t.indexOf("stream/")+7).split("?")[0];try{return JSON.parse(decodeURIComponent(s))}catch{return null}}updateDownloadProgress(t,s){document.dispatchEvent(new CustomEvent(this.progressEventName,{detail:{url:t,progress:s}}))}}const p=new m;return c.downloader=p,Object.defineProperty(c,Symbol.toStringTag,{value:"Module"}),c}({});
